@page
@model NETCSHARP_FRONTEND.Pages.RentModel
@using System.Text.Json
@{
    var idValue = Request.Query["id"].ToString() ?? "";
    var idJson = JsonSerializer.Serialize(idValue); 
    var start = Request.Query["start"].ToString() ?? "";
    var startJson = JsonSerializer.Serialize(start); 
    var end = Request.Query["end"].ToString() ?? "";
    var endJson = JsonSerializer.Serialize(end);
}
<!--
PSEUDOCODE / PLAN (detailed):
1. Replace static table cell text with spans that have stable IDs:
   - car-type, car-name, car-transmission, car-passengers,
     renter-name, rental-dates, price-day, total-price
2. Keep existing server-side serialized values: idJson, startJson, endJson.
3. After fetching `res` (the car object) in `check()`:
   a. Populate each span's innerText using properties from `res`:
      - use optional chaining and fallbacks if a property is missing.
   b. Use startJson and endJson (from query) to display rental dates.
   c. If price per day exists (res.pricePerDay), compute total price:
      - parse start/end as dates, compute day difference (inclusive),
      - total = days * pricePerDay, format as localized currency string.
   d. Initialize carousel as before with `res.images`.
4. Defensive coding:
   - validate arrays, handle missing fields, show fallback texts.
5. Keep rest of page behavior (carousel, session check, rent button).
-->
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
 </style>
<body class="rt-body">
    <div class="rt-container">
        <h1 class="rt-title">Sewa Mobil</h1>

        <div class="rt-carousel">
            <div class="rt-carousel-inner">
                
            </div>
            <button class="rt-carousel-btn rt-carousel-btn-prev" onclick="changeSlide(-1)">❮ Prev</button>
            <button class="rt-carousel-btn rt-carousel-btn-next" onclick="changeSlide(1)">Next ❯</button>
        </div>

        <div class="rt-card">
            <h2 class="rt-card-title">Informasi Mobil</h2>
            <table class="rt-info-table">
                <tr class="rt-info-row">
                    <td class="rt-info-label">Tipe Mobil</td>
                    <td class="rt-info-value"><span id="car-type">-</span></td>
                </tr>
                <tr class="rt-info-row">
                    <td class="rt-info-label">Nama Mobil</td>
                    <td class="rt-info-value"><span id="car-name">-</span></td>
                </tr>
                <tr class="rt-info-row">
                    <td class="rt-info-label">Transmisi</td>
                    <td class="rt-info-value"><span id="car-transmission">-</span></td>
                </tr>
                <tr class="rt-info-row">
                    <td class="rt-info-label">Jumlah Penumpang</td>
                    <td class="rt-info-value"><span id="car-passengers">-</span></td>
                </tr>
                <tr class="rt-info-row">
                    <td class="rt-info-label">Nama Penyewa</td>
                    <td class="rt-info-value"><span id="renter-name">-</span></td>
                </tr>
                <tr class="rt-info-row">
                    <td class="rt-info-label">Tanggal Sewa</td>
                    <td class="rt-info-value"><span id="rental-dates">-</span></td>
                </tr>
                <tr class="rt-info-row">
                    <td class="rt-info-label">Harga Sewa</td>
                    <td class="rt-info-value"><span id="price-day">-</span></td>
                </tr>
                <tr class="rt-info-row">
                    <td class="rt-info-label">Total Harga Sewa</td>
                    <td class="rt-info-value"><span id="total-price">-</span></td>
                </tr>
            </table>
            <button class="rt-btn-rent" onclick="handleRent()">Sewa</button>
        </div>
    </div>

    <script>
        // Helper: format number to Indonesian Rupiah currency string
    function formatCurrencyIDR(amount) {
        if (typeof amount !== 'number' || !isFinite(amount)) return '-';
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(amount);
    }

    // Helper: safe set text
    function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.innerText = text ?? '-';
    }

    async function check(){
            var jew = new JWTManager();
            let x =  await jew.validate();
            console.log(x)
            if(!x.valid){
                alert('your session has been expired')
                window.location.href = '/login';
            }
            else {
                const res = await core.fetchCar(@Html.Raw(idJson)) // btw ini bahaya soalnya ada resiko kena reflective smth xss (tapi udah diserialize sih)
                console.log(res)
                populateFromRes(res);
                initCarousel(res.images)
                showSlide(0)
            }

    }
    check()
    const urlId = @Html.Raw(idJson); 
    const queryStart = @Html.Raw(startJson);
    const queryEnd = @Html.Raw(endJson);

    let currentSlide = 0;

    function getSlides() {
        return document.querySelectorAll('.rt-carousel-item');
    }

    function showSlide(n) {
        const slides = getSlides();
        if (!slides || slides.length === 0) {
            return;
        }

        if (typeof n !== 'number') {
            n = currentSlide;
        }

        if (slides[currentSlide]) {
            slides[currentSlide].classList.remove('rt-active');
        }

        const len = slides.length;
        currentSlide = ((n % len) + len) % len;

        if (slides[currentSlide]) {
            slides[currentSlide].classList.add('rt-active');
        }
    }

    function changeSlide(direction) {
        const slides = getSlides();
        if (!slides || slides.length === 0) {
            return;
        }
        showSlide(currentSlide + direction);
    }

    function handleRent() {
        if (urlId) {
            alert('Terima kasih! Permintaan sewa mobil (id=' + urlId + ') Anda akan diproses.');
        } else {
            alert('Terima kasih! Permintaan sewa mobil Anda akan diproses.');
        }
    }

    
    setInterval(() => {
        changeSlide(1);
    }, 5000);

    function initCarousel(images) {
        const carouselInner = document.querySelector('.rt-carousel-inner');
        carouselInner.innerHTML = ''; 

        if (!Array.isArray(images) || images.length === 0) {
            const placeholder = document.createElement('div');
            placeholder.className = 'rt-carousel-item rt-active';
            placeholder.textContent = 'No images available';
            carouselInner.appendChild(placeholder);
            currentSlide = 0;
            return;
        }

        images.forEach((image, index) => {
            const slideDiv = document.createElement('div');
            slideDiv.className = 'rt-carousel-item';
            if (index === 0) {
                slideDiv.classList.add('rt-active');
            }

            const img = document.createElement('img');
            img.src = image.imageLink;
            img.alt = image.imageCarId ?? ('slide-' + index);

            slideDiv.appendChild(img);
            carouselInner.appendChild(slideDiv);
        });

        currentSlide = 0;
        showSlide(0);
    }

    function populateFromRes(res) {
        if (!res || typeof res !== 'object') {
            return;
        }

        const type = res.model
        const name = res.name 
        const transmission = res.transmission 
        const passengers =res.nus
        setText('car-type', type);
        setText('car-name', name);
        setText('car-transmission', transmission);
        setText('car-passengers', passengers);

        const startStr = (queryStart && queryStart !== '""') ? JSON.parse(queryStart) : (res.startDate ?? res.rentalStart ?? '');
        const endStr = (queryEnd && queryEnd !== '""') ? JSON.parse(queryEnd) : (res.endDate ?? res.rentalEnd ?? '');

        let displayDates = '-';
        let days = null;
        try {
            if (startStr && endStr) {
                const s = new Date(startStr);
                const e = new Date(endStr);
                if (!isNaN(s) && !isNaN(e)) {
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    const sText = s.toLocaleDateString('id-ID', options);
                    const eText = e.toLocaleDateString('id-ID', options);
                    displayDates = sText + ' sampai ' + eText;

                    // compute difference in days (inclusive)
                    const diffMs = e.setHours(0,0,0,0) - s.setHours(0,0,0,0);
                    days = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
                    if (days <= 0) days = 1;
                } else {
                    // fallback to raw strings
                    displayDates = `${startStr} sampai ${endStr}`;
                }
            } else if (startStr || endStr) {
                displayDates = (startStr || endStr);
                days = 1;
            } else if (res.startDate && res.endDate) {
                displayDates = `${res.startDate} sampai ${res.endDate}`;
                days = 1;
            }
        } catch (err) {
            console.warn('date parse error', err);
            displayDates = (startStr || '-') + ' sampai ' + (endStr || '-');
        }

        setText('rental-dates', displayDates);

        // Price per day and total price calculation
        const pricePerDay = (typeof res.pricePerDay === 'number') ? res.pricePerDay : (typeof res.price === 'number' ? res.price : (res.pricePerDay ? Number(res.pricePerDay) : NaN));
        if (isFinite(pricePerDay)) {
            setText('price-day', formatCurrencyIDR(pricePerDay) + ' / hari');
            const total = (days && isFinite(days)) ? pricePerDay * days : NaN;
            setText('total-price', isFinite(total) ? formatCurrencyIDR(total) : '-');
        } else {
            // fallback: if res.priceString present
            if (res.priceString) {
                setText('price-day', res.priceString + ' / hari');
            } else {
                setText('price-day', '-');
            }
            setText('total-price', '-');
        }
    }
    </script>
</body>
